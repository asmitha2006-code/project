import json
import os
from datetime import datetime

file_name="study_planner.json"


def load_data():
    if not os.path.exists(file_name):
        return {"streak": 0, "tasks": {}}

    with open(file_name, "r") as file:
        data = json.load(file)

    if "streak" not in data:
        data["streak"] = 0
    if "tasks" not in data:
        data["tasks"] = {}

    return data

def save_data(data):
    with open(file_name,'w') as file:
        json.dump(data,file,indent=4)


def add_tasks(today, data):
    n = int(input("Enter the number of tasks to be added: "))

    new_tasks = []
    for i in range(n):
        task = input(f"Enter task {i+1}: ")
        new_tasks.append({
            "task": task,
            "completed": False,
            "priority": None
        })

    if today in data["tasks"]:
        data["tasks"][today].extend(new_tasks)
    else:
        data["tasks"][today] = new_tasks

    save_data(data)
    print("TASKS ADDED SUCCESSFULLY âœ…")


def set_priority(data, today=None):
    if today is None:
        today = str(date.today())

    if today not in data["tasks"]:
        print("No tasks for today âŒ")
        return

    tasks = data["tasks"][today]

    n = int(input("No. of tasks to be prioritised: "))
    for _ in range(n):
        task_name = input("Task to be prioritised: ")
        priority = input("Priority: ")

        for task in tasks:
            if task["task"] == task_name:
                task["priority"] = priority

    save_data(data)
    print("Priority is set âœ…")

def mark_task_completed(today, data):
    if today not in data["tasks"]:
        print(f"No tasks found for {today} ğŸ¥²")
        return

    tasks = data["tasks"][today]
    n = int(input("Enter the number of tasks to be marked: "))

    for _ in range(n):
        task_name = input("Enter the task: ")
        for task in tasks:
            if task["task"] == task_name:
                task["completed"] = True
                break
        else:
            print("Task not found ğŸ‘ğŸ»")

    save_data(data)
    print("Tasks are marked ğŸ‘")


from datetime import date

def list_tasks(data, today=None):
    if today is None:
        today = str(date.today())

    if today not in data["tasks"]:
        print("No tasks for today âŒ")
        return

    for i, task in enumerate(data["tasks"][today], start=1):
        status = "âœ… Completed" if task["completed"] else "âŒ Pending"
        print(f"{i}. {task['task']} â€” {status}, {task['priority']}")


def show_progress(today, data):
    if today not in data["tasks"]:
        print("No tasks for today âŒ")
        return

    tasks = data["tasks"][today]
    done = sum(task["completed"] for task in tasks)
    total = len(tasks)

    percentage = (done / total) * 100
    print(f"Today's completion: {percentage:.2f}% ğŸ“ˆ")


def delete_task(data, today=None):
    if today is None:
        today = str(date.today())

    if today not in data["tasks"] or not data["tasks"][today]:
        print("No tasks to delete âŒ")
        return

    list_tasks(data, today)

    choice = int(input("Enter task number to delete: "))
    confirm = input("Are you sure? (y/n): ")

    if confirm.lower() == "y":
        deleted_task = data["tasks"][today].pop(choice - 1)

        if not data["tasks"][today]:
            del data["tasks"][today]

        save_data(data)
        print(f"Task '{deleted_task['task']}' deleted successfully ğŸ—‘ï¸")


def main():
    data=load_data()
    today=datetime.now().strftime("%Y-%m-%d")

    while True:
        print("\n-----DAILY STUDY PLANNER-----")
        print("1.ADD TASKS")
        print("2.SET PRIORITY")
        print("3.MARK TASK AS COMPLETED")
        print("4.SHOW PROGRESS")
        print("5.LIST TASKS")
        print("6.DELETE TASK")
        print("7.EXIT")

        choice=int(input("Enter your choice : "))

        match choice:
            case 1:
                add_tasks(today,data)
            case 2:
                set_priority(data)
            case 3:
                mark_task_completed(today,data)
            case 4:
                show_progress(today,data)
            case 5:
                list_tasks(data)
            case 6:
                delete_task(data)
            case 7:
                print("KEEP IT UP!ğŸ‘ğŸ»GOODBYE!ğŸ‘‹ğŸ»")
                break
            case 8:
                print("Invalid choice,try again")


if __name__=="__main__":
    main()
